#!/usr/bin/env bash
set -euo pipefail

make > /dev/null

expected='MODULE
INCLUDE
FN
RETURN
IDENT ident
ATTR packed
IDENT mut
STRING string
CHAR c
INT8
INT16
INT32
INT64
UINT8
UINT16
UINT32
UINT64
NULL
LPAREN
RPAREN
LBRACE
RBRACE
LBRACK
RBRACK
NUMBER 0
COLON
SEMICOLON
DOUBLECOLON
COMMA
DOT
AMP
QUESTION
PLUS
MINUS
STAR
DIV
RSHIFT
LSHIFT
EQ_EQ
GREATER
LESS
GREATER_EQ
LESS_EQ
EQ
PLUS_EQ
MINUS_EQ
STAR_EQ
DIV_EQ
RSHIFT_EQ
LSHIFT_EQ
EOF'

# create temp files and ensure cleanup
exp_file=$(mktemp)
act_file=$(mktemp)
trap 'rm -f "$exp_file" "$act_file"' EXIT

# write expected to file
printf '%s\n' "$expected" > "$exp_file"

# count expected lines
lines=$(wc -l < "$exp_file")

# capture only the first $lines lines of stdout (ignore stderr)
./coda test/lexer.coda 2>/dev/null | head -n "$lines" > "$act_file" || true

# run unified diff
if diff -u --label expected --label actual "$exp_file" "$act_file"; then
  printf "\x1b[1;32mLEXER TEST PASSED\n"
  exit 0
else
  echo
  printf "\x1b[1;31mLEXER TEST FAILED\n"
  exit 1
fi
